title: DP前端开发
date: 2013-10-31
tags: [DP, 前端]
---

针对预约预定的同学在前端开发中所提出的一些疑问，做了一些整理，希望对大家有帮助。

一. 如何新建一个前端项目

1.创建仓库.

在code.dianpingoa.com上创建前端项目，namespace选 f2e。

项目命名一般有如下不成文规定：

前端项目都以 -static结尾

面向用户的项目以    业务名称-static 命名，如 booking-static, tuangou-static

商户中心的项目以    bc-业务名称-static命名，如bc-booking-static

移动的项目以            m-业务名称-static命名，如m-booking-static

2.项目的目录结构

--js js目录

--css css目录

-----img css中用到的背景图目录

--.cortex ci配置目录

-----package.json 配置文件

其他几个目录都很清晰，重点介绍下 package.json

package.json 是给ci的配置文件，用来配置哪些目录需要部署到测试和线上，以及部署到什么位置。

以booking-static为例：
```
{
    "dirs": [
    {
        "dir": "css/",
        "to": "/s/c/app/booking"
    },
    {
        "dir": "img/",
        "to":"/s/i/app/booking"
    },
    {
        "dir": "js/",
        "to": "/s/j/app/booking"
    }]
}
```

css目录下的文件a.css，最终会发布到```http://(各环境domain)/s/c/app/booking/a.css```下，java项目中引用这个文件

```<link rel="stylesheet" href="<@ava.staticResource resource="/s/c/app/booking/a.css" />" type="text/css" />```

3.ci 配置

找scm的王静发配置 alpha, beta, product 3个ci即可, 名称为 (alpha/beta/product)-仓库名，例如```alpha-booking-static```

4.button配置


在[这里](!https://docs.google.com/a/dianping.com/spreadsheet/ccc?key=0AqA6J_cKUVL8dHc2N3VpUXlWMEdHS0gxc3lobVROR2c#gid=0)填写下申请，参照其他静态项目即可

二.上线，缓存，版本相关问题

1.线上文件为什么需要版本号？

把最新的文件上传到服务器上不就可以了吗,为什么要版本号？

一次页面的请求，会有几十个静态文件请求，包括css，js，image等，如果web服务器有1000的qps，那么静态文件服务器就需要有50w qps，所以静态文件都会有一种叫做CDN(Content Delivery Network)的东西。简单来说，他将一个静态文件请求的内容缓存在CDN节点中，避免用户直接访问源服务器，减少服务器的压力。

当服务器的静态文件更新后，CDN上的内容还是老的，用户访问到的内容还是老的，所以会在文件的url上带一个版本号，使文件的url改变，让CDN做一次回源，以更新CDN的文件内容。

2.如何升级版本号

当静态文件发布后，会为每个文件按文件内容生成一个MD5版本号，保存在数据库中。

每个web服务器会有一个本地缓存来缓存这些版本号。

一般上线的步骤是先发布静态文件，然后再发布web应用，原因是上线完静态文件后，数据库版本号更新，但是本地缓存没有更新，当应用灰度发布的时候会一台台重启，本地缓存就会自动清除。

如果没有按这个顺序，就需要在button上手动清除一下缓存。

3.如何排查静态文件没有更新的问题

2个常识：去掉url上的.min可以查看不压缩的代码，url加一堆乱七八糟的querystring，可以让CDN回源

1.打开beta.ci.dp , 查看 product-你的项目的构建信息，查看对应的文件打包信息中的版本号，和线上访问的版本号是否一致，如果一致，看2. 如果不一致 看3.

2.去掉.min，查看不压缩的代码，如果文件内容是最新的，呼叫运维（付华)，手动更新CDN，如果不是最新的，一定是你的代码没合并。

3.打包的版本号和线上版本号不一致，那么多半是缓存的原因，清缓存，如果还没有效果，继续..

4.到这一步都没效果，那么问题应该是数据库读库和写库不同步，读库不是最新的版本号，那么call dba（兽老师）查看数据库同步问题。

三.常用的开发工具，插件

1.chrome开发者工具

最常用的开发工具，看这个ppt，非常涨姿势http://www.igvita.com/slides/2012/devtools-tips-and-tricks/

2.代理工具

windows下面fiddler ，可以写正则，代理整个文件夹到本地目录。

mac/linux下，我习惯用hrt，https://github.com/tudouui/hrt

3.浏览器插件

cookie，switchysharp

差不多这些就够用了

四.Neuron框架相关。

API 文档 http://neuron.f2e.dp

框架大致包含这几部分：

1.语言增强：

Array.prototype
- indexOf
- lastIndexOf
- filter
- forEach
- every
- map
- some
- reduce
- reduceRight

Object
- create
- keys

String.prototype
- trim
- trimLeft
- trimRight

为不支持ES5这些规范的浏览器实现了这些API，不清楚API是干什么的可以到 https://developer.mozilla.org/zh-CN/ 上查询，这些API可以大大简化开发，尤其是数组的那些，避免掉很多for循环，建议一定要看下！！

2.Loader

模块加载器，依赖管理，动态加载模块，使用DP.define([],function(){}) 定义模块，DP.require or DP.provide 加载模块，随便找个文件看看就知道了。

loader的原理和机制说来话长，放到分享上面解释吧。。。

3.DOM操作API

最常用的DOM操作API，类似于jQuery, 在chrome的控制台输入 DP.DOM.prototype，可以看到所有DOM操作的API，比查文档快多了...

4.一些常用工具函数

例如 DP.data() , DP.ready() , DP.isArray等等，

在控制台打DP, 就懂了

这些是neuron.js所提供的

5.其他常用的组件都以模块的形式按需加载，最常用的模块：

io/ajax and io/jsonp    发起ajax请求

dom/dimension 获取元素的大小，位置等，类似jquery的 .offset(), .width() ，API不太一样

util/cookie cookie操作

fx/core 动画组件，mootools的Fx模块

switch/core 幻灯片组件

会上面的这些，你就可以完成90%的业务需求了。

五. 什么是bc-bootstrap

一套商户中心的UI and js组件框架，看名字就知道，类似于大名鼎鼎的bootstrap，省去大量重构和js开发时间，神器！

bootstrap.fb.dp/

上面有详细的说明