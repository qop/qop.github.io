title: ci系统
date: 2016-03-10
tags: [ci, nodejs, 前端]
---

一般来说ci要做的事情就是把开发环境的代码构建完之后丢到线上去，这里面ci系统要做哪些事，开哪些口子都得看实际的业务需要，本文只是列举一个比较好的实践。

- 读取当前系统环境，打印在日志上方便排查由于环境或者版本造成的问题。
```
'echo $PATH',
'node -v',
'npm -v',
'npm config get registry'
```

- 清空destination，此处可以由用户（此处用户指的是ci系统的用户，即业务开发）指定，如果不设置就读取默认配置，比如/dist文件夹。
```
rm -rf dist
```

- 跑用户指定的构建脚本，gulp, grunt, webpack等各种方式，输出到/dist即可。这时候/dist里应该有**/*.@(html|js|css|jpg|jpeg|png|gif)这些文件。
```
"script": {
    "build": "gulp"
}
```

- 文件名校验，文件名应该由小写字母、数字、分隔符、下划线和点组成。```/^[a-z0-9_\-\.\/]+$/```

- 替换css中引用的相对路径，比如背景图，应该直接引用发到cdn上的静态文件地址。

- 压缩css。不多说了，推荐用clean-css。

- 压缩js。不多说，推荐用uglify-js。

- 压缩图片。图片推荐用imagemin，有针对jpg, jpeg, png, gif的工具。

- 给静态文件加md5。形如/dist/lib/zepto.min.js ==> /dist/lib/zepto.min.md5.js

- 替换html中引用静态资源的相对路径。

- 上传ftp。

- 更新数据库版本号。